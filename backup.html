<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Saurav's Karkhana | Attendance System</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
body{font-family:Arial;background:#f4f6f8;margin:0}
header{background:#198754;color:#fff;padding:15px;text-align:center}
.tabs{display:flex;background:#fff}
.tabs button{flex:1;padding:12px;border:none;background:#f8f9fa;cursor:pointer}
.tabs button.active{background:#0d6efd;color:#fff;font-weight:bold}
.container{display:none;padding:15px}
.container.active{display:block}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#0d6efd;color:#fff}
input,select,button{padding:6px}
button{border:none;border-radius:4px}
.btn-add{background:#198754;color:#fff}
.btn-edit{background:#ffc107}
.btn-delete{background:#dc3545;color:#fff}
.btn-save{background:#198754;color:#fff}
.btn-excel{background:#0dcaf0}
.btn-pdf{background:#dc3545;color:#fff}
.actions{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
.work-box div{display:flex;gap:5px;margin-bottom:5px}
.summary{font-weight:bold;margin-top:10px}
</style>
</head>

<body>

<header>
<h1>Saurav's Karkhana</h1>
<p>Labour Attendance & Wage System</p>
</header>

<div class="tabs">
<button class="active" onclick="openTab('users',this)">Users</button>
<button onclick="openTab('works',this)">Works</button>
<button onclick="openTab('attendance',this)">Attendance</button>
<button onclick="openTab('reports',this)">Reports</button>
</div>

<!-- USERS -->
<div id="users" class="container active">
<h2>User Management</h2>
<input id="userName" placeholder="Labour Name">
<button class="btn-add" onclick="addUser()">Add</button>
<table>
<thead><tr><th>#</th><th>Name</th><th>Action</th></tr></thead>
<tbody id="userTable"></tbody>
</table>
</div>

<!-- WORKS -->
<div id="works" class="container">
<h2>Work Management</h2>
<input id="workName" placeholder="Work Name">
<input id="workRate" type="number" placeholder="Rate">
<button class="btn-add" onclick="addWork()">Add Work</button>
<table>
<thead><tr><th>#</th><th>Work</th><th>Rate</th><th>Action</th></tr></thead>
<tbody id="workTable"></tbody>
</table>
</div>

<!-- ATTENDANCE -->
<div id="attendance" class="container">
<h2>Attendance — <input type="date" id="attendanceDate"></h2>
<table id="attendanceTable">
<thead>
<tr><th>Name</th><th>Works (Multiple)</th><th>Total Wage</th></tr>
</thead>
<tbody></tbody>
</table>
<div class="summary">Day Total: ₹ <span id="dayTotal">0</span></div>
<button class="btn-save" onclick="submitAttendance()">Submit Attendance</button>
</div>

<!-- REPORTS -->
<div id="reports" class="container">
<h2>Reports</h2>
From <input type="date" id="fromDate">
To <input type="date" id="toDate">
<div class="actions">
<button class="btn-excel" onclick="downloadExcel()">Download Excel</button>
<button class="btn-pdf" onclick="downloadPDF()">Download PDF</button>
</div>
</div>

<script>
// ---------------- TABS ----------------
function openTab(id,btn){
 document.querySelectorAll('.container').forEach(c=>c.classList.remove('active'));
 document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
 document.getElementById(id).classList.add('active');
 btn.classList.add('active');
}

// ---------------- DATA ----------------
let users = JSON.parse(localStorage.getItem("users")) || [{id:1,name:"Ramesh"}];
let works = JSON.parse(localStorage.getItem("works")) || [{id:1,name:"1st Kiln",rate:400}];
let attendanceData = JSON.parse(localStorage.getItem("attendance")) || [];

attendanceDate.value = new Date().toISOString().split("T")[0];

// ---------------- USERS ----------------
function renderUsers(){
 userTable.innerHTML="";
 users.forEach((u,i)=>{
  userTable.innerHTML+=`
  <tr>
   <td>${i+1}</td>
   <td>${u.name}</td>
   <td>
    <button class="btn-edit" onclick="editUser(${u.id})">Edit</button>
    <button class="btn-delete" onclick="deleteUser(${u.id})">Delete</button>
   </td>
  </tr>`;
 });
 renderAttendance();
}
function addUser(){
 if(!userName.value) return;
 users.push({id:Date.now(),name:userName.value});
 userName.value="";
 saveUsers();
}
function editUser(id){
 const u=users.find(x=>x.id===id);
 const n=prompt("Edit name",u.name);
 if(n){u.name=n;saveUsers();}
}
function deleteUser(id){
 if(confirm("Delete user?")){
  users=users.filter(u=>u.id!==id);
  saveUsers();
 }
}
function saveUsers(){
 localStorage.setItem("users",JSON.stringify(users));
 renderUsers();
}

// ---------------- WORKS ----------------
function renderWorks(){
 workTable.innerHTML="";
 works.forEach((w,i)=>{
  workTable.innerHTML+=`
  <tr>
   <td>${i+1}</td>
   <td>${w.name}</td>
   <td>${w.rate}</td>
   <td>
    <button class="btn-edit" onclick="editWork(${w.id})">Edit</button>
    <button class="btn-delete" onclick="deleteWork(${w.id})">Delete</button>
   </td>
  </tr>`;
 });
}
function addWork(){
 if(!workName.value||!workRate.value) return;
 works.push({id:Date.now(),name:workName.value,rate:+workRate.value});
 workName.value=""; workRate.value="";
 saveWorks();
}
function editWork(id){
 const w=works.find(x=>x.id===id);
 const n=prompt("Work name",w.name);
 const r=prompt("Rate",w.rate);
 if(n&&r){w.name=n;w.rate=+r;saveWorks();}
}
function deleteWork(id){
 if(confirm("Delete work?")){
  works=works.filter(w=>w.id!==id);
  saveWorks();
 }
}
function saveWorks(){
 localStorage.setItem("works",JSON.stringify(works));
 renderWorks();
 renderAttendance();
}

// ---------------- ATTENDANCE ----------------
function renderAttendance(){
 const tb=attendanceTable.querySelector("tbody");
 tb.innerHTML="";
 users.forEach(u=>{
  tb.innerHTML+=`
  <tr>
   <td>${u.name}</td>
   <td>
    <div class="work-box"></div>
    <button onclick="addWorkRow(this)">+ Add Work</button>
   </td>
   <td class="wage">0</td>
  </tr>`;
 });
}

function addWorkRow(btn){
 const box = btn.previousElementSibling;
 const div = document.createElement("div");

 div.innerHTML = `
  <select onchange="calcPerson(this)">
    <option value="" selected disabled>Select Work</option>
    ${works.map(w=>`<option value="${w.name}" data-rate="${w.rate}">${w.name}</option>`).join("")}
  </select>
  <select onchange="calcPerson(this)">
    <option value="" selected disabled>Select Hours</option>
    ${Array.from({length:24},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join("")}
  </select>
  <button onclick="removeWorkRow(this)">❌</button>
 `;
 box.appendChild(div);
}

function removeWorkRow(btn){
 const workDiv = btn.parentElement;
 const row = btn.closest("tr");

 workDiv.remove();

 let total = 0;
 row.querySelectorAll(".work-box div").forEach(d=>{
  const w=d.children[0], h=d.children[1];
  if(!w.value||!h.value) return;
  total += +w.selectedOptions[0].dataset.rate * +h.value;
 });
 row.querySelector(".wage").innerText = total;
 calcDay();
}

function calcPerson(el){
 const row=el.closest("tr");
 let total=0;
 row.querySelectorAll(".work-box div").forEach(d=>{
  const w=d.children[0], h=d.children[1];
  if(!w.value||!h.value) return;
  total += +w.selectedOptions[0].dataset.rate * +h.value;
 });
 row.querySelector(".wage").innerText=total;
 calcDay();
}

function calcDay(){
 let t=0;
 document.querySelectorAll(".wage").forEach(w=>t+=+w.innerText);
 dayTotal.innerText=t;
}

// ---------------- SUBMIT ----------------
function submitAttendance(){
 const date = attendanceDate.value;
 const data = [];

 document.querySelectorAll("#attendanceTable tbody tr").forEach(r=>{
  const worksArr = [];

  r.querySelectorAll(".work-box div").forEach(d=>{
   const w = d.children[0];
   const h = d.children[1];
   if(!w.value || !h.value) return;

   worksArr.push({
    work: w.value,
    hours: Number(h.value),
    rate: Number(w.selectedOptions[0].dataset.rate),
    wage: Number(h.value) * Number(w.selectedOptions[0].dataset.rate)
   });
  });

  // ✅ Only push if work exists
  if (worksArr.length > 0) {
    data.push({
      name: r.children[0].innerText,
      works: worksArr
    });
  }
 });

 const rec = { company:"Saurav's Karkhana", date, data };
 const i = attendanceData.findIndex(a=>a.date===date);
 i>=0 ? attendanceData[i]=rec : attendanceData.push(rec);

 localStorage.setItem("attendance", JSON.stringify(attendanceData));
 renderAttendance();
 dayTotal.innerText = "0";
 alert("Saved for " + date);
}


// ---------------- REPORTS ----------------
function getReport(){
 const f=fromDate.value,t=toDate.value;
 return attendanceData.filter(a=>(!f||a.date>=f)&&(!t||a.date<=t))
 .sort((a,b)=>new Date(a.date)-new Date(b.date));
}

function downloadExcel(){
 const report = getReport();
 if (!Array.isArray(report) || report.length === 0) {
   alert("No data available");
   return;
 }

 // Detect month/year
 const baseDate = new Date(report[0].date);
 const monthName = baseDate.toLocaleString('en', { month: 'short' });
 const year = baseDate.getFullYear();
 const daysInMonth = new Date(year, baseDate.getMonth()+1, 0).getDate();

 const totalCols = 3 + daysInMonth + 3; // SR,NAME,WORK + days + totals

 const rows = [];
 const merges = [];

 /* ---------------- TITLE ROW ---------------- */
 const titleRow = Array(totalCols).fill("");
 titleRow[0] = `EXXARO MONTHLY ATTENDANCE – ${monthName}-${year}`;
 rows.push(titleRow);

 merges.push({
   s: { r: 0, c: 0 },
   e: { r: 0, c: totalCols - 1 }
 });

 /* ---------------- HEADER TEMPLATE ---------------- */
 const headerTemplate = [
   "SR NO", "NAME", "WORK",
   ...Array.from({length: daysInMonth}, (_,i)=>`${i+1}-${monthName}`),
   "TOTAL HAJRI",
   "WORK PAYMENT",
   "MONTHLY PAYMENT"
 ];

 let rowIndex = 1;
 let srNo = 1;

 /* --------- BUILD PERSON → WORK → DAY MAP --------- */
 const personMap = {};

 report.forEach(r => {
   if (!Array.isArray(r.data)) return;
   const day = new Date(r.date).getDate();

   r.data.forEach(p => {
     if (!p.name || !Array.isArray(p.works)) return;
     if (!personMap[p.name]) personMap[p.name] = {};

     p.works.forEach(w => {
       if (!personMap[p.name][w.work]) {
         personMap[p.name][w.work] = { rate: Number(w.rate), days: {} };
       }
       personMap[p.name][w.work].days[day] = Number(w.hours);
     });
   });
 });

 /* ---------------- BUILD ROWS ---------------- */
 Object.keys(personMap).forEach((personName, personIdx) => {

   // ➕ User-specific header row
   rows.push([...headerTemplate]);
   rowIndex++;

   const works = personMap[personName];
   const personStartRow = rowIndex;
   let monthlyPayment = 0;
   let first = true;

   Object.keys(works).forEach(workName => {
     const work = works[workName];
     let totalHours = 0;

     const row = [];
     row.push(first ? srNo : "");
     row.push(first ? personName : "");
     row.push(workName);

     for (let d = 1; d <= daysInMonth; d++) {
       const hrs = work.days[d] || "";
       if (hrs) totalHours += hrs;
       row.push(hrs);
     }

     const hajri = totalHours / 6;
     const workPayment = hajri * work.rate;
     monthlyPayment += workPayment;

     row.push(hajri);
     row.push(workPayment);
     row.push("");

     rows.push(row);
     rowIndex++;
     first = false;
   });

   const endRow = rowIndex - 1;

   // Merge SR NO
   merges.push({ s:{r:personStartRow,c:0}, e:{r:endRow,c:0} });
   // Merge NAME
   merges.push({ s:{r:personStartRow,c:1}, e:{r:endRow,c:1} });
   // Merge MONTHLY PAYMENT
   merges.push({
     s:{r:personStartRow,c:totalCols-1},
     e:{r:endRow,c:totalCols-1}
   });

   rows[personStartRow][0] = srNo;
   rows[personStartRow][1] = personName;
   rows[personStartRow][totalCols-1] = monthlyPayment;

   srNo++;

   /* -------- LIGHT GREEN SEPARATOR ROW -------- */
   if (personIdx < Object.keys(personMap).length - 1) {
     const blankRow = Array(totalCols).fill("");
     rows.push(blankRow);

     merges.push({
       s:{r:rowIndex,c:0},
       e:{r:rowIndex,c:totalCols-1}
     });

     rowIndex++;
   }
 });

 /* ---------------- CREATE EXCEL ---------------- */
 const wb = XLSX.utils.book_new();
 const ws = XLSX.utils.aoa_to_sheet(rows);

 ws["!merges"] = merges;

 // Column widths (readability)
 ws["!cols"] = [
   { wch: 6 }, { wch: 18 }, { wch: 22 },
   ...Array(daysInMonth).fill({ wch: 6 }),
   { wch: 12 }, { wch: 14 }, { wch: 18 }
 ];

 // Freeze title + headers
 ws["!freeze"] = { xSplit: 3, ySplit: 2 };

 /* -------- APPLY LIGHT GREEN BG TO SEPARATOR ROWS -------- */
 Object.keys(ws).forEach(cell => {
   if (!cell.startsWith("!")) {
     const row = XLSX.utils.decode_cell(cell).r;
     if (rows[row] && rows[row].every(v => v === "")) {
       ws[cell].s = {
         fill: { fgColor: { rgb: "E2F0D9" } }
       };
     }
   }
 });

 XLSX.utils.book_append_sheet(wb, ws, "Monthly Attendance");
 XLSX.writeFile(wb, `EXXARO_Monthly_Attendance_${monthName}-${year}.xlsx`);
}


function downloadPDF(){
 const { jsPDF } = window.jspdf;
 const doc = new jsPDF();

 doc.text("Saurav's Karkhana Attendance Report",14,15);
 let y = 25;

 const report = getReport();

 if (report.length === 0) {
   alert("No data available for selected date range");
   return;
 }

 report.forEach(r=>{
  if (!Array.isArray(r.data)) return;

  doc.text("Date: " + r.date, 14, y);
  y += 5;

  const rows = [];

  r.data.forEach(p=>{
   if (!Array.isArray(p.works)) return;

   p.works.forEach(w=>{
    rows.push([
     p.name,
     w.work,
     w.hours,
     w.rate,
     w.wage
    ]);
   });
  });

  if (rows.length === 0) return;

  doc.autoTable({
   head:[["Name","Work","Hours","Rate","Wage"]],
   body:rows,
   startY:y,
   styles:{fontSize:9}
  });

  y = doc.lastAutoTable.finalY + 10;
  if (y > 260) {
    doc.addPage();
    y = 20;
  }
 });

 doc.save("Sauravs_Karkhana_Attendance_Report.pdf");
}


renderUsers();
renderWorks();
</script>

</body>
</html>
